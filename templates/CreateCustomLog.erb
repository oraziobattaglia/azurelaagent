# CreateCustomLog.ps1
#
# Author: Orazio Battaglia
# Thanks to: https://raw.githubusercontent.com/thebitstreamer/toolbox/master/AZMON-CreateCustomLog.ps1
#
# Works in 2 ways:
# -command get 
# -command set 
#
# TODO
# Parametrizzare e provare. Serve un modo per accedere alla sottoscrizione probabilmente una applicazione con permessi specifici
# vedi https://docs.microsoft.com/it-it/azure/active-directory/develop/howto-create-service-principal-portal#required-permissions
param (
  [String]
  $command
)

$application_id = "<%= @application_id %>"
$username = "<%= @username %>"
$password = ConvertTo-SecureString "<%= @password %>" -AsPlainText -Force
$tenant_id = "<%= @tenant_id %>"

$resource_group = "<%= @resource_group %>"
$workspace_name = "<%= @workspace_name %>"
$customLog_name = "<%= @title %>"

switch ($command) {

  "get" {

  } # end get

  "set" {
        # Custom Log to collect
        # Customize "fileSystemLocations" to the path where files are
        # more info here https://docs.microsoft.com/en-us/azure/azure-monitor/platform/powershell-workspace-configuration

        # Connect to Azure
        $mycreds = New-Object System.Management.Automation.PSCredential ($username, $password)
        Connect-AzAccount -ServicePrincipal -ApplicationId  $application_id -Credential $mycreds -TenantId $tenant_id

$customLog = @"
{
    "customLogName": "sampleCustomLog1", 
    "description": "Example custom log datasource", 
    "inputs": [
        { 
            "location": { 
            "fileSystemLocations": { 
                "windowsFileTypeLogPaths": [<% if @windows_log_paths != [] -%> "<%= @windows_log_paths.join('", "') %>" <% end -%>],  
                "linuxFileTypeLogPaths": [<% if @linux_log_paths != [] -%> "<%= @linux_log_paths.join('", "') %>" <% end -%>] 
                } 
            }, 
        "recordDelimiter": { 
            "regexDelimiter": { 
                "pattern": "\\n", 
                "matchIndex": 0, 
                "matchIndexSpecified": true, 
                "numberedGroup": null 
                } 
            } 
        }
    ], 
    "extractions": [
        { 
            "extractionName": "TimeGenerated", 
            "extractionType": "DateTime", 
            "extractionProperties": { 
                "dateTimeExtraction": { 
                    "regex": null, 
                    "joinStringRegex": null 
                    } 
                } 
            }
        ] 
    }
"@
        # Custom Logs
        New-AzOperationalInsightsCustomLogDataSource -ResourceGroupName $resource_group -WorkspaceName $workspace_name -CustomLogRawJson "$customLog" -Name $customLog_name

        # Disconnect from Azure
        Disconnect-AzAccount
        
  } # end set

  default {
  
  } # end default
  
} # end switch